{% extends 'base.html' %} {% block title %}编辑个人资料 - 提示词管理平台{%
endblock %} {% block styles %}
<style>
  .profile-edit-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 15px;
  }

  .profile-card {
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .profile-header {
    background: linear-gradient(
      135deg,
      var(--primary-color),
      var(--primary-dark)
    );
    color: white;
    padding: 1.5rem;
    text-align: center;
  }

  .profile-header .avatar {
    width: 90px;
    height: 90px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    margin: 0 auto 1rem;
  }

  .profile-body {
    padding: 2rem;
    background-color: #fff;
  }

  .nav-tabs {
    border-bottom: 2px solid var(--light-bg);
    margin-bottom: 2rem;
  }

  .nav-tabs .nav-link {
    border: none;
    font-weight: 500;
    color: var(--text-muted);
    padding: 0.75rem 1.5rem;
    margin-bottom: -2px;
  }

  .nav-tabs .nav-link.active {
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    background: transparent;
  }

  .nav-tabs .nav-link:hover:not(.active) {
    border-bottom: 2px solid var(--light-bg);
    color: var(--text-color);
  }

  .form-section {
    margin-bottom: 2rem;
  }

  .section-title {
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--light-bg);
  }

  .password-toggle {
    position: absolute;
    right: 10px;
    top: 45px;
    cursor: pointer;
    z-index: -10;
  }

  /* 头像上传相关样式 */
  .avatar-upload {
    position: relative;
    display: inline-block;
  }

  .avatar-preview {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto;
    border: 2px solid var(--primary-light);
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  .default-avatar {
    width: 100%;
    height: 100%;
    background: var(--primary-light);
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
  }

  .avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* AI设置相关样式 */
  .advanced-settings {
    display: none;
  }

  .advanced-settings.show {
    display: block;
  }

  .test-connection-btn {
    margin-left: 0.5rem;
  }
</style>
{% endblock %} {% block content %}
<div class="profile-edit-container">
  <div class="profile-card">
    <div class="profile-header">
      <div class="avatar">
        <i class="bi bi-person"></i>
      </div>
      <h1 class="h3 mb-1">编辑个人资料</h1>
      <p class="mb-0">更新您的资料和账号设置</p>
    </div>

    <div class="profile-body">
      <ul class="nav nav-tabs" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link {% if current_tab == 'basic' or not current_tab %}active{% endif %}"
            id="basic-tab"
            data-bs-toggle="tab"
            data-bs-target="#basic"
            type="button"
            role="tab"
            aria-controls="basic"
            aria-selected="{% if current_tab == 'basic' or not current_tab %}true{% else %}false{% endif %}"
          >
            <i class="bi bi-person-vcard me-2"></i>基本资料
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link {% if current_tab == 'security' %}active{% endif %}"
            id="security-tab"
            data-bs-toggle="tab"
            data-bs-target="#security"
            type="button"
            role="tab"
            aria-controls="security"
            aria-selected="{% if current_tab == 'security' %}true{% else %}false{% endif %}"
          >
            <i class="bi bi-shield-lock me-2"></i>安全设置
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link {% if current_tab == 'ai' %}active{% endif %}"
            id="ai-tab"
            data-bs-toggle="tab"
            data-bs-target="#ai"
            type="button"
            role="tab"
            aria-controls="ai"
            aria-selected="{% if current_tab == 'ai' %}true{% else %}false{% endif %}"
          >
            <i class="bi bi-robot me-2"></i>AI 设置
          </button>
        </li>
      </ul>

      <div class="tab-content" id="profileTabContent">
        <div
          class="tab-pane fade {% if current_tab == 'basic' or not current_tab %}show active{% endif %}"
          id="basic"
          role="tabpanel"
          aria-labelledby="basic-tab"
        >
          <form
            method="POST"
            action="{{ url_for('user.edit_profile') }}"
            id="profile-form"
            enctype="multipart/form-data"
          >
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-person-fill me-2"></i>个人信息
              </h5>

              <!-- 头像上传区域 -->
              <div class="mb-4 text-center">
                <div class="avatar-upload">
                  <div class="avatar-preview mb-3">
                    {% if user.avatar_url %}
                    <img
                      src="{{ user.avatar_url }}"
                      alt="{{ user.username }}"
                      id="avatarPreview"
                      class="rounded-circle"
                      width="120"
                      height="120"
                    />
                    {% else %}
                    <div class="default-avatar" id="avatarPreview">
                      <i class="bi bi-person"></i>
                    </div>
                    {% endif %}
                  </div>
                  <label for="avatar" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-camera me-1"></i>上传头像
                  </label>
                  <input
                    type="file"
                    name="avatar"
                    id="avatar"
                    class="d-none"
                    accept="image/jpeg,image/png,image/gif"
                  />
                  <div class="form-text mt-1">
                    支持JPG、PNG和GIF格式，建议尺寸200x200像素
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="username" class="form-label">用户名</label>
                <input
                  type="text"
                  class="form-control"
                  id="username"
                  name="username"
                  value="{{ user.username }}"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">邮箱地址</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  value="{{ user.email }}"
                  required
                />
              </div>
            </div>

            <div class="text-end">
              <a
                href="{{ url_for('user.profile', user_id=session.user_id) }}"
                class="btn btn-outline-secondary me-2"
              >
                <i class="bi bi-x-circle me-1"></i>取消
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>保存修改
              </button>
            </div>
          </form>
        </div>

        <div
          class="tab-pane fade {% if current_tab == 'security' %}show active{% endif %}"
          id="security"
          role="tabpanel"
          aria-labelledby="security-tab"
        >
          <form
            method="POST"
            action="{{ url_for('user.edit_profile') }}"
            id="password-form"
          >
            <input type="hidden" name="username" value="{{ user.username }}" />
            <input type="hidden" name="email" value="{{ user.email }}" />

            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-key-fill me-2"></i>更改密码
              </h5>

              <div class="mb-3 position-relative">
                <label for="current_password" class="form-label"
                  >当前密码</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="current_password"
                  name="current_password"
                  required
                />
                <span
                  class="password-toggle"
                  onclick="togglePasswordVisibility('current_password', 'currentPasswordIcon')"
                >
                  <i id="currentPasswordIcon" class="bi bi-eye-slash"></i>
                </span>
              </div>

              <div class="mb-3 position-relative">
                <label for="new_password" class="form-label">新密码</label>
                <input
                  type="password"
                  class="form-control"
                  id="new_password"
                  name="new_password"
                  required
                  minlength="8"
                />
                <span
                  class="password-toggle"
                  onclick="togglePasswordVisibility('new_password', 'newPasswordIcon')"
                >
                  <i id="newPasswordIcon" class="bi bi-eye-slash"></i>
                </span>
                <div class="form-text">密码至少需要8个字符</div>
              </div>

              <div class="mb-3 position-relative">
                <label for="confirm_password" class="form-label"
                  >确认新密码</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirm_password"
                  name="confirm_password"
                  required
                />
                <span
                  class="password-toggle"
                  onclick="togglePasswordVisibility('confirm_password', 'confirmPasswordIcon')"
                >
                  <i id="confirmPasswordIcon" class="bi bi-eye-slash"></i>
                </span>
              </div>
            </div>

            <div class="text-end">
              <a
                href="{{ url_for('user.profile', user_id=session.user_id) }}"
                class="btn btn-outline-secondary me-2"
              >
                <i class="bi bi-x-circle me-1"></i>取消
              </a>
              <button type="submit" class="btn btn-danger">
                <i class="bi bi-key me-1"></i>更改密码
              </button>
            </div>
          </form>
        </div>

        <div
          class="tab-pane fade {% if current_tab == 'ai' %}show active{% endif %}"
          id="ai"
          role="tabpanel"
          aria-labelledby="ai-tab"
        >
          <form
            method="POST"
            action="{{ url_for('user.edit_profile', tab='ai') }}"
            id="aiSettingsForm"
          >
            <!-- AI 提供商配置 -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-cloud me-2"></i>AI 提供商配置
              </h5>

              <div class="mb-3">
                <label for="provider" class="form-label fw-bold">AI 提供商</label>
                <select class="form-select" id="provider" name="provider" required>
                  <option value="openai" {% if config and config.provider == 'openai' %}selected{% endif %}>
                    OpenAI (GPT-3.5/GPT-4)
                  </option>
                  <option value="custom" {% if config and config.provider == 'custom' %}selected{% endif %}>
                    自定义 API (兼容 OpenAI 格式)
                  </option>
                </select>
              </div>

              <div class="mb-3">
                <label for="api_key" class="form-label fw-bold">
                  API Key
                  {% if config and config.api_key %}
                  <span class="badge bg-success ms-2">已配置</span>
                  {% endif %}
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="api_key"
                  name="api_key"
                  placeholder="{% if config and config.api_key %}留空保持原 Key，或输入新 Key 进行更新{% else %}输入您的 API Key{% endif %}"
                  value=""
                  autocomplete="off"
                />
                {% if config and config.api_key %}
                <div class="form-text text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  已配置 API Key，留空将保持原 Key 不变
                </div>
                {% endif %}
              </div>

              <div class="mb-3" id="baseUrlGroup" style="display: {% if config and config.provider == 'custom' %}block{% else %}none{% endif %};">
                <label for="base_url" class="form-label fw-bold">基础 URL</label>
                <input
                  type="url"
                  class="form-control"
                  id="base_url"
                  name="base_url"
                  placeholder="https://api.openai.com/v1"
                  value="{% if config and config.base_url %}{{ config.base_url }}{% endif %}"
                />
                <div class="form-text">
                  自定义 API 的基础 URL（兼容 OpenAI 格式）
                </div>
              </div>

              <div class="mb-3">
                <label for="model" class="form-label fw-bold">模型</label>
                <input
                  type="text"
                  class="form-control"
                  id="model"
                  name="model"
                  placeholder="gpt-3.5-turbo"
                  value="{% if config and config.model %}{{ config.model }}{% else %}gpt-3.5-turbo{% endif %}"
                  required
                />
                <div class="form-text">
                  例如：gpt-3.5-turbo, gpt-4, gpt-4-turbo
                </div>
              </div>

              <div class="mb-3">
                <button type="button" class="btn btn-outline-primary btn-sm" id="testConnectionBtn">
                  <i class="bi bi-wifi me-1"></i>测试连接
                </button>
                <span id="testResult" class="ms-2"></span>
              </div>
            </div>

            <!-- 高级设置 -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-sliders me-2"></i>
                <span>高级设置</span>
                <button
                  type="button"
                  class="btn btn-link btn-sm p-0 ms-2"
                  id="toggleAdvanced"
                  style="text-decoration: none; color: var(--text-muted)"
                >
                  <i class="bi bi-chevron-down" id="toggleAdvancedIcon"></i>
                </button>
              </h5>

              <div class="advanced-settings" id="advancedSettings" style="display: none;">
                <div class="mb-3">
                  <label for="temperature" class="form-label fw-bold">温度 (Temperature)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="temperature"
                    name="temperature"
                    min="0"
                    max="2"
                    step="0.1"
                    value="{% if config and config.temperature %}{{ config.temperature }}{% else %}0.7{% endif %}"
                  />
                  <div class="form-text">控制输出的随机性，范围 0.0-2.0，默认 0.7</div>
                </div>

                <div class="mb-3">
                  <label for="max_tokens" class="form-label fw-bold">最大 Token 数</label>
                  <input
                    type="number"
                    class="form-control"
                    id="max_tokens"
                    name="max_tokens"
                    min="100"
                    max="2000"
                    value="{% if config and config.max_tokens %}{{ config.max_tokens }}{% else %}500{% endif %}"
                  />
                  <div class="form-text">生成内容的最大长度，范围 100-2000，默认 500</div>
                </div>
              </div>
            </div>

            <!-- 启用开关 -->
            <div class="form-section">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="enabled"
                  name="enabled"
                  {% if not config or config.enabled %}checked{% endif %}
                />
                <label class="form-check-label fw-bold" for="enabled">
                  启用 AI 自动填充功能
                </label>
              </div>
            </div>

            <!-- 提交按钮 -->
            <div class="text-end">
              <a
                href="{{ url_for('user.profile', user_id=session.user_id) }}"
                class="btn btn-outline-secondary me-2"
              >
                <i class="bi bi-x-circle me-1"></i>取消
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>保存设置
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 密码表单验证
    const passwordForm = document.getElementById("password-form");
    if (passwordForm) {
      passwordForm.addEventListener("submit", function (e) {
        const currentPassword = document.getElementById("current_password");
        const newPassword = document.getElementById("new_password");
        const confirmPassword = document.getElementById("confirm_password");

        let hasError = false;

        // 清除所有验证错误
        [currentPassword, newPassword, confirmPassword].forEach((field) => {
          field.classList.remove("is-invalid");
        });

        // 验证表单
        if (!currentPassword.value) {
          currentPassword.classList.add("is-invalid");
          hasError = true;
        }

        if (!newPassword.value || newPassword.value.length < 8) {
          newPassword.classList.add("is-invalid");
          hasError = true;
        }

        if (
          !confirmPassword.value ||
          confirmPassword.value !== newPassword.value
        ) {
          confirmPassword.classList.add("is-invalid");
          hasError = true;
        }

        if (hasError) {
          e.preventDefault();
        }
      });
    }
  });

  // 密码显示切换功能
  function togglePasswordVisibility(inputId, iconId) {
    const passwordInput = document.getElementById(inputId);
    const icon = document.getElementById(iconId);

    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      icon.classList.replace("bi-eye-slash", "bi-eye");
    } else {
      passwordInput.type = "password";
      icon.classList.replace("bi-eye", "bi-eye-slash");
    }
  }

  // 根据URL参数自动激活对应的标签
  document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get("tab");
    
    if (tab === "security") {
      const securityTab = document.getElementById("security-tab");
      if (securityTab) {
        const bootstrapTab = new bootstrap.Tab(securityTab);
        bootstrapTab.show();
      }
    } else if (tab === "ai") {
      const aiTab = document.getElementById("ai-tab");
      if (aiTab) {
        const bootstrapTab = new bootstrap.Tab(aiTab);
        bootstrapTab.show();
      }
    }
  });

  // 头像预览
  document.getElementById("avatar").addEventListener("change", function (e) {
    if (this.files && this.files[0]) {
      const reader = new FileReader();

      reader.onload = function (e) {
        const preview = document.getElementById("avatarPreview");

        // 如果预览区域当前是默认头像
        if (preview.classList.contains("default-avatar")) {
          // 创建一个新的图片元素替换默认头像
          const img = document.createElement("img");
          img.id = "avatarPreview";
          img.className = "rounded-circle";
          img.width = 120;
          img.height = 120;
          img.src = e.target.result;

          // 替换元素
          const parent = preview.parentNode;
          parent.replaceChild(img, preview);
        } else {
          // 如果已经是图片，只需更新src
          preview.src = e.target.result;
        }
      };

      reader.readAsDataURL(this.files[0]);
    }
  });

  // AI设置相关脚本
  document.addEventListener("DOMContentLoaded", function () {
    const providerSelect = document.getElementById("provider");
    const baseUrlGroup = document.getElementById("baseUrlGroup");
    const toggleAdvanced = document.getElementById("toggleAdvanced");
    const advancedSettings = document.getElementById("advancedSettings");
    const testConnectionBtn = document.getElementById("testConnectionBtn");
    const testResult = document.getElementById("testResult");

    if (providerSelect && baseUrlGroup) {
      // 切换提供商时显示/隐藏基础 URL
      providerSelect.addEventListener("change", function () {
        if (this.value === "custom") {
          baseUrlGroup.style.display = "block";
          const baseUrlInput = document.getElementById("base_url");
          if (baseUrlInput) baseUrlInput.required = true;
        } else {
          baseUrlGroup.style.display = "none";
          const baseUrlInput = document.getElementById("base_url");
          if (baseUrlInput) baseUrlInput.required = false;
        }
      });
    }

    if (toggleAdvanced && advancedSettings) {
      // 切换高级设置显示/隐藏
      toggleAdvanced.addEventListener("click", function () {
        const isVisible = advancedSettings.style.display === "block";
        advancedSettings.style.display = isVisible ? "none" : "block";
        const icon = document.getElementById("toggleAdvancedIcon");
        if (icon) {
          if (!isVisible) {
            icon.classList.remove("bi-chevron-down");
            icon.classList.add("bi-chevron-up");
          } else {
            icon.classList.remove("bi-chevron-up");
            icon.classList.add("bi-chevron-down");
          }
        }
      });
    }

    if (testConnectionBtn) {
      // 测试连接
      testConnectionBtn.addEventListener("click", async function () {
        const provider = providerSelect ? providerSelect.value : "openai";
        const apiKeyInput = document.getElementById("api_key");
        const apiKey = apiKeyInput ? apiKeyInput.value.trim() : "";
        const baseUrlInput = document.getElementById("base_url");
        const baseUrl = baseUrlInput ? baseUrlInput.value.trim() || null : null;
        const modelInput = document.getElementById("model");
        const model = modelInput ? modelInput.value.trim() : "gpt-3.5-turbo";

        testConnectionBtn.disabled = true;
        testConnectionBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-1"></span>测试中...';
        if (testResult) testResult.innerHTML = "";

        try {
          const response = await fetch("/api/ai/test-connection", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              provider: provider,
              api_key: apiKey,
              base_url: baseUrl,
              model: model,
            }),
          });

          const data = await response.json();

          if (testResult) {
            if (data.success) {
              testResult.innerHTML =
                '<span class="text-success"><i class="bi bi-check-circle me-1"></i>连接成功</span>';
            } else {
              testResult.innerHTML =
                '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>' +
                (data.message || "连接失败") +
                "</span>";
            }
          }
        } catch (error) {
          if (testResult) {
            testResult.innerHTML =
              '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>网络错误</span>';
          }
        } finally {
          testConnectionBtn.disabled = false;
          testConnectionBtn.innerHTML = '<i class="bi bi-wifi me-1"></i>测试连接';
        }
      });
    }
  });
</script>
{% endblock %}
